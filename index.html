async function handleExport(file) {
    if (!file) return;

    const status = document.getElementById("statusExport");
    status.innerText = "⏳ Analyse du fichier...";
    document.getElementById("ctrlExport").classList.add("hidden");

    try {

        // ==============================
        // 1️⃣ CAS JSON HARMONY
        // ==============================
        if (file.name.toLowerCase().endsWith(".json")) {

            const text = await file.text();
            const data = JSON.parse(text);

            if (!data.songs || !Array.isArray(data.songs)) {
                throw new Error("JSON invalide : structure inattendue.");
            }

            const songs = data.songs.map(s => ({
                title: s.title || "Titre inconnu",
                artist: s.artists?.map(a => a.name).join(" & ") || "Artiste inconnu",
                album: s.album?.name || "Album inconnu",
                duration: s.duration || 0,
                url: s.videoId ? `https://www.youtube.com/watch?v=${s.videoId}` : ""
            }));

            const playlistName = data.playlistInfo?.title || file.name.replace(".json","");

            const csv = buildCSV(songs);
            const m3u = buildM3U(songs);

            downloadBlob(csv, `${playlistName}.csv`);
            downloadBlob(m3u, `${playlistName}.m3u`);

            status.innerText = `✅ JSON converti : ${songs.length} titres exportés.`;
            return;
        }

        // ==============================
        // 2️⃣ CAS BACKUP ZIP (.backup)
        // ==============================
        const zip = await JSZip.loadAsync(file);

        const dbFile = zip.file("song.db");
        if (!dbFile) {
            throw new Error("Archive valide mais fichier song.db introuvable.");
        }

        const dbData = await dbFile.async("uint8array");
        const SQL = await initSqlJs(sqlConfig);
        const db = new SQL.Database(dbData);

        const playlistRes = db.exec("SELECT name, id FROM playlist");
        let playlists = [];

        if (playlistRes.length) {
            playlists = playlistRes[0].values.map(r => ({
                id: r[1],
                name: r[0]
            }));
        }

        const likedRes = db.exec("SELECT COUNT(*) FROM song WHERE liked=1");
        if (likedRes.length && likedRes[0].values[0][0] > 0) {
            playlists.unshift({ id: "liked", name: "Favoris (Liked)" });
        }

        backupData = { db, playlists };
        displayPlaylists(playlists);

        status.innerText = `✅ Backup chargé : ${playlists.length} playlists détectées.`;

    } catch (e) {

        console.error(e);

        if (e.message.includes("central directory")) {
            status.innerText = "❌ Ce fichier n'est pas un backup valide (ZIP attendu).";
        } else {
            status.innerText = "❌ Erreur : " + e.message;
        }
    }
}
