<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Music Converter Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background:#f0f2f5; padding:20px; color: #333; }
        .container { max-width: 1000px; margin: auto; display: flex; gap: 20px; flex-wrap: wrap; }
        .card { background: white; border-radius: 12px; padding: 20px; flex: 1; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        h2 { color: #1a73e8; font-size: 1.4em; margin-bottom: 20px; }
        
        .dropZone { 
            border: 2px dashed #bdc3c7; padding: 40px 20px; background: #fafafa; 
            cursor: pointer; border-radius: 8px; transition: 0.3s; margin-bottom: 15px;
        }
        .dropZone:hover { border-color: #1a73e8; background: #f1f7fe; }
        
        button { 
            padding: 10px 18px; margin: 5px; cursor: pointer; background: #1a73e8; 
            color: white; border: none; border-radius: 6px; font-weight: 500;
        }
        button:hover { background: #1557b0; }
        input[type="text"] { padding: 8px; width: 80%; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0; }
        .hidden { display: none; }
        .status { font-size: 0.9em; margin-top: 10px; font-weight: bold; }
        .footer-info { margin-top: 10px; font-size: 0.8em; color: #666; }
    </style>
</head>
<body>

<h1 style="text-align:center;">ðŸ”„ Music Playlist Bridge</h1>

<div class="container">
    
    <div class="card">
        <h2>Exportation</h2>
        <p>Harmony (.json) ou OuterTunen ou Metrolist (.backup)<br><b>VERS</b> M3U / CSV</p>
        <div id="dropExport" class="dropZone">Glissez votre JSON ou BACKUP ici</div>
        <input type="file" id="fileExport" class="hidden" accept=".json,.backup">
        
        <div id="ctrlExport" class="hidden">
            <input type="text" id="nameExport" placeholder="Nom du fichier">
            <br>
            <button onclick="downloadFile(currentData.csv, 'csv')">TÃ©lÃ©charger CSV</button>
            <button onclick="downloadFile(currentData.m3u, 'm3u')">TÃ©lÃ©charger M3U</button>
        </div>
        <div id="statusExport" class="status"></div>
    </div>

    <div class="card">
        <h2>Importation</h2>
        <p>CSV ou M3U<br><b>VERS</b> Harmony JSON</p>
        <div id="dropImport" class="dropZone">Glissez votre CSV ou M3U ici</div>
        <input type="file" id="fileImport" class="hidden" accept=".csv,.m3u">
        
        <div id="ctrlImport" class="hidden">
            <input type="text" id="nameImport" placeholder="Nom de la playlist">
            <br>
            <button onclick="downloadFile(currentData.json, 'json')">GÃ©nÃ©rer Harmony JSON</button>
        </div>
        <div id="statusImport" class="status"></div>
    </div>

</div>

<script>
let currentData = { csv: "", m3u: "", json: "" };
const sqlConfig = { locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` };

// Setup des zones de drop
setupZone("dropExport", "fileExport", handleExport);
setupZone("dropImport", "fileImport", handleImport);

function setupZone(zoneId, inputId, handler) {
    const zone = document.getElementById(zoneId);
    const input = document.getElementById(inputId);
    zone.onclick = () => input.click();
    zone.ondragover = (e) => { e.preventDefault(); zone.style.borderColor = "#1a73e8"; };
    zone.ondragleave = () => { zone.style.borderColor = "#bdc3c7"; };
    zone.ondrop = (e) => { e.preventDefault(); zone.style.borderColor = "#bdc3c7"; handler(e.dataTransfer.files[0]); };
    input.onchange = (e) => handler(e.target.files[0]);
}


// --- LOGIQUE EXPORT  ---
async function handleExport(file) {
    if (!file) return;
    const status = document.getElementById("statusExport");
    status.innerText = "â³ Analyse du backup...";
   
    try {
        let songs = [];
        if (file.name.endsWith(".backup")) {
            // Support universel pour OuterTune et MetroList
            songs = await processSqliteBackup(file);
        } else if (file.name.endsWith(".json")) {
            const text = await file.text();
            const data = JSON.parse(text);
            songs = (data.songs || []).map(s => ({
                title: s.title,
                artist: (s.artists || []).map(a => a.name).join(" & "),
                album: s.album?.name || "",
                duration: s.duration || 0,
                url: s.videoId ? `https://www.youtube.com/watch?v=${s.videoId}` : ""
            }));
        }

        currentData.csv = "Title,Artist,Album,Duration,YouTubeURL\n" + songs.map(s => `"${s.title}","${s.artist}","${s.album}","${s.duration}","${s.url}"`).join("\n");
        currentData.m3u = "#EXTM3U\n" + songs.map(s => `#EXTINF:${s.duration},${s.artist} - ${s.title}\n${s.url}`).join("\n");
       
        document.getElementById("nameExport").value = file.name.split('.')[0];
        document.getElementById("ctrlExport").classList.remove("hidden");
        status.innerText = `âœ… ${songs.length} titres extraits avec succÃ¨s.`;
    } catch (e) {
        console.error(e);
        status.innerText = "âŒ Erreur : " + e.message;
    }
}

async function processSqliteBackup(file) {
    const zip = await JSZip.loadAsync(file);
    const dbFile = zip.file("song.db");
   
    if (!dbFile) throw new Error("Fichier song.db introuvable dans le backup.");
   
    const dbData = await dbFile.async("uint8array");
    const SQL = await initSqlJs(sqlConfig);
    const db = new SQL.Database(dbData);
   
    // RequÃªte compatible MetroList & OuterTune (rÃ©cupÃ¨re les titres likÃ©s)
    const query = `
        SELECT s.title,
               (SELECT GROUP_CONCAT(a.name, ' & ') FROM artist a
                JOIN song_artist_map sam ON a.id = sam.artistId
                WHERE sam.songId = s.id) as artists,
               s.albumName, s.duration, s.id
        FROM song s
        WHERE s.liked = 1
    `;
   
    const res = db.exec(query);
    if (!res.length) return [];
   
    return res[0].values.map(r => ({
        title: r[0],
        artist: r[1] || "Artiste inconnu",
        album: r[2] || "Album inconnu",
        duration: r[3] || 0,
        url: r[4] ? `https://www.youtube.com/watch?v=${r[4]}` : ""
    }));
}

async function processOuterTune(file) {
    const zip = await JSZip.loadAsync(file);
    const dbData = await zip.file("song.db").async("uint8array");
    const SQL = await initSqlJs(sqlConfig);
    const db = new SQL.Database(dbData);
    const res = db.exec("SELECT s.title, GROUP_CONCAT(a.name, ' & '), s.albumName, s.duration, s.id FROM song s LEFT JOIN song_artist_map sam ON s.id = sam.songId LEFT JOIN artist a ON sam.artistId = a.id WHERE s.liked = 1 GROUP BY s.id");
    
    return res.length ? res[0].values.map(r => ({ title: r[0], artist: r[1], album: r[2], duration: r[3], url: r[4] ? `https://www.youtube.com/watch?v=${r[4]}` : "" })) : [];
}

// --- LOGIQUE IMPORT (CSV/M3U -> JSON) ---
async function handleImport(file) {
    if (!file) return;
    const status = document.getElementById("statusImport");
    const text = await file.text();
    let songs = [];

    try {
        if (file.name.endsWith(".csv")) {
            const lines = text.split("\n").slice(1);
            songs = lines.filter(l => l.trim()).map(line => {
                const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v => v.replace(/^"|"$/g, ''));
                return createSongObj(c[0], c[1], c[2], c[3], c[4]);
            });
        } else if (file.name.endsWith(".m3u")) {
            const lines = text.split("\n");
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith("#EXTINF:")) {
                    const info = lines[i].split(",")[1];
                    const [artist, title] = info.includes(" - ") ? info.split(" - ") : ["Inconnu", info];
                    const url = lines[i+1]?.startsWith("http") ? lines[i+1] : "";
                    songs.push(createSongObj(title.trim(), artist.trim(), "", 0, url));
                }
            }
        }

        currentData.json = JSON.stringify({ playlistInfo: { title: file.name.split('.')[0] }, songs: songs }, null, 2);
        document.getElementById("nameImport").value = file.name.split('.')[0] + "_harmony";
        document.getElementById("ctrlImport").classList.remove("hidden");
        status.innerText = `âœ… ${songs.length} titres convertis en JSON.`;
    } catch (e) {
        status.innerText = "âŒ Erreur de lecture.";
    }
}

function createSongObj(title, artist, album, duration, url) {
    const vId = url.includes("v=") ? url.split("v=")[1].split("&")[0] : "";
    return {
        title: title,
        artists: [{ name: artist }],
        album: { name: album },
        duration: parseInt(duration) || 0,
        videoId: vId
    };
}

function downloadFile(content, ext) {
    const name = (ext === 'json' ? document.getElementById("nameImport").value : document.getElementById("nameExport").value) || "playlist";
    const blob = new Blob([content], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `${name}.${ext}`;
    a.click();
}
</script>
<div id="exportLinks">
    <h3>Transfert entre sites streaming (Spotify, Deezer, YoutubeMusic ..) :</h3>
    <a href="https://www.tunemymusic.com/" target="_blank">
        <button>TuneMyMusic</button>
    </a>
    <a href="https://soundiiz.com/" target="_blank">
        <button> Soundiiz</button>
    </a>
    <a href="https://freeyourmusic.com/fr/" target="_blank">
        <button> FreeYourMusic</button>
    </a>
</div>

</body>
</html>



