<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Music Converter Pro - Multi-Playlist</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
<style>
body { font-family: 'Segoe UI', sans-serif; background:#f0f2f5; padding:20px; color: #333; }
.container { max-width: 1000px; margin:auto; display:flex; gap:20px; flex-wrap:wrap; }
.card { background:white; border-radius:12px; padding:20px; flex:1; min-width:300px; box-shadow:0 4px 6px rgba(0,0,0,0.1); text-align:center; }
h2 { color:#1a73e8; font-size:1.4em; margin-bottom:20px; }
.dropZone { border:2px dashed #bdc3c7; padding:40px 20px; background:#fafafa; cursor:pointer; border-radius:8px; transition:0.3s; margin-bottom:15px; }
.dropZone:hover { border-color:#1a73e8; background:#f1f7fe; }
button { padding:10px 18px; margin:5px; cursor:pointer; background:#1a73e8; color:white; border:none; border-radius:6px; font-weight:500; }
button:hover { background:#1557b0; }
input[type="text"] { padding:8px; width:80%; border:1px solid #ddd; border-radius:4px; margin:10px 0; }
.hidden { display:none; }
.status { font-size:0.9em; margin-top:10px; font-weight:bold; }
.playlist-list { text-align:left; max-height:150px; overflow-y:auto; margin-bottom:10px; }
.playlist-item { display:flex; align-items:center; margin:5px 0; }
.playlist-item input { margin-right:8px; }
</style>
</head>
<body>

<h1 style="text-align:center;">ðŸ”„ Music Playlist Bridge - Multi-Playlist</h1>

<div class="container">
  <div class="card">
    <h2>Exportation Backup â†’ CSV/M3U</h2>
    <p>Harmony, OuterTune ou MetroList (.backup)<br><b>VERS</b> CSV / M3U</p>
    <div id="dropExport" class="dropZone">Glissez votre backup ici</div>
    <input type="file" id="fileExport" class="hidden" accept=".json,.backup">
    <div id="ctrlExport" class="hidden">
      <div class="playlist-list" id="playlistList"></div>
      <button onclick="exportSelectedPlaylists()">Exporter les playlists sÃ©lectionnÃ©es</button>
    </div>
    <div id="statusExport" class="status"></div>
  </div>

  <div class="card">
    <h2>Importation CSV/M3U â†’ Harmony JSON</h2>
    <p>CSV ou M3U<br><b>VERS</b> Harmony JSON</p>
    <div id="dropImport" class="dropZone">Glissez vos CSV ou M3U ici</div>
    <input type="file" id="fileImport" class="hidden" accept=".csv,.m3u">
    <div id="ctrlImport" class="hidden">
      <input type="text" id="nameImport" placeholder="Nom de la playlist">
      <br>
      <button onclick="downloadFile(currentData.json, 'json')">GÃ©nÃ©rer Harmony JSON</button>
    </div>
    <div id="statusImport" class="status"></div>
  </div>
</div>

<script>
let currentData = { csv: {}, m3u: {}, json: "" };
let backupData = null;
const sqlConfig = { locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` };

// Setup drag & drop zones
setupZone("dropExport", "fileExport", handleExport);
setupZone("dropImport", "fileImport", handleImport);

function setupZone(zoneId, inputId, handler) {
    const zone = document.getElementById(zoneId);
    const input = document.getElementById(inputId);
    zone.onclick = () => input.click();
    zone.ondragover = e => { e.preventDefault(); zone.style.borderColor="#1a73e8"; };
    zone.ondragleave = () => { zone.style.borderColor="#bdc3c7"; };
    zone.ondrop = e => { e.preventDefault(); zone.style.borderColor="#bdc3c7"; handler(e.dataTransfer.files[0]); };
    input.onchange = e => handler(e.target.files[0]);
}

// ---------------- EXPORT ----------------
async function handleExport(file) {
    if (!file) return;

    const status = document.getElementById("statusExport");
    status.innerText = "â³ Analyse du fichier...";
    document.getElementById("ctrlExport").classList.add("hidden");

    try {

        // ==============================
        // 1ï¸âƒ£ CAS JSON HARMONY
        // ==============================
        if (file.name.toLowerCase().endsWith(".json")) {

            const text = await file.text();
            const data = JSON.parse(text);

            if (!data.songs || !Array.isArray(data.songs)) {
                throw new Error("JSON invalide : structure inattendue.");
            }

            const songs = data.songs.map(s => ({
                title: s.title || "Titre inconnu",
                artist: s.artists?.map(a => a.name).join(" & ") || "Artiste inconnu",
                album: s.album?.name || "Album inconnu",
                duration: s.duration || 0,
                url: s.videoId ? `https://www.youtube.com/watch?v=${s.videoId}` : ""
            }));

            const playlistName = data.playlistInfo?.title || file.name.replace(".json","");

            const csv = buildCSV(songs);
            const m3u = buildM3U(songs);

            downloadBlob(csv, `${playlistName}.csv`);
            downloadBlob(m3u, `${playlistName}.m3u`);

            status.innerText = `âœ… JSON converti : ${songs.length} titres exportÃ©s.`;
            return;
        }

        // ==============================
        // 2ï¸âƒ£ CAS BACKUP ZIP (.backup)
        // ==============================
        const zip = await JSZip.loadAsync(file);

        const dbFile = zip.file("song.db");
        if (!dbFile) {
            throw new Error("Archive valide mais fichier song.db introuvable.");
        }

        const dbData = await dbFile.async("uint8array");
        const SQL = await initSqlJs(sqlConfig);
        const db = new SQL.Database(dbData);

        const playlistRes = db.exec("SELECT name, id FROM playlist");
        let playlists = [];

        if (playlistRes.length) {
            playlists = playlistRes[0].values.map(r => ({
                id: r[1],
                name: r[0]
            }));
        }

        const likedRes = db.exec("SELECT COUNT(*) FROM song WHERE liked=1");
        if (likedRes.length && likedRes[0].values[0][0] > 0) {
            playlists.unshift({ id: "liked", name: "Favoris (Liked)" });
        }

        backupData = { db, playlists };
        displayPlaylists(playlists);

        status.innerText = `âœ… Backup chargÃ© : ${playlists.length} playlists dÃ©tectÃ©es.`;

    } catch (e) {

        console.error(e);

        if (e.message.includes("central directory")) {
            status.innerText = "âŒ Ce fichier n'est pas un backup valide (ZIP attendu).";
        } else {
            status.innerText = "âŒ Erreur : " + e.message;
        }
    }
}
function displayPlaylists(playlists) {
    const container = document.getElementById("playlistList");
    container.innerHTML = "";
    playlists.forEach(p => {
        const div = document.createElement("div");
        div.className = "playlist-item";
        div.innerHTML = `<input type="checkbox" value="${p.id}" checked> ${p.name}`;
        container.appendChild(div);
    });
    document.getElementById("ctrlExport").classList.remove("hidden");
}

// RÃ©cupÃ©rer chansons d'une playlist
function getSongsFromPlaylist(db, playlistId) {
    if (playlistId === "liked") {
        // Liked songs
        const res = db.exec(`
            SELECT s.title,
                   GROUP_CONCAT(a.name,' & ') AS artists,
                   s.albumName,
                   s.duration,
                   s.id
            FROM song s
            LEFT JOIN song_artist_map sam ON s.id = sam.songId
            LEFT JOIN artist a ON sam.artistId = a.id
            WHERE s.liked=1
            GROUP BY s.id
        `);
        return formatSongs(res);
    } else {
        // Playlist normale
        // On met l'ID entre guillemets pour compatibilitÃ© SQLite TEXT ou INT
        const res = db.exec(`
            SELECT s.title,
                   GROUP_CONCAT(a.name,' & ') AS artists,
                   s.albumName,
                   s.duration,
                   s.id
            FROM song s
            JOIN playlist_song_map psm ON s.id = psm.songId
            JOIN playlist pl ON pl.id = '${playlistId}'
            LEFT JOIN song_artist_map sam ON s.id = sam.songId
            LEFT JOIN artist a ON sam.artistId = a.id
            GROUP BY s.id
        `);
        return formatSongs(res);
    }
}
function formatSongs(res) {
    if (!res.length) return [];
    return res[0].values.map(r => ({
        title: r[0],
        artist: r[1] || "Artiste inconnu",
        album: r[2] || "Album inconnu",
        duration: r[3] || 0,
        url: r[4] ? `https://www.youtube.com/watch?v=${r[4]}` : ""
    }));
}

function exportSelectedPlaylists() {
    if (!backupData) return;
    const checkboxes = document.querySelectorAll("#playlistList input[type=checkbox]");
    const exportedNames = [];

    checkboxes.forEach(cb => {
        if (cb.checked) {
            const playlistName = cb.nextSibling.textContent.trim();
            const songs = getSongsFromPlaylist(backupData.db, cb.value);

            if (songs.length === 0) return; // Ignorer si aucune chanson

            const csv = buildCSV(songs);
            const m3u = buildM3U(songs);

            currentData.csv[cb.value] = csv;
            currentData.m3u[cb.value] = m3u;

            // TÃ©lÃ©charger les fichiers
            downloadBlob(csv, `${playlistName}.csv`);
            downloadBlob(m3u, `${playlistName}.m3u`);

            exportedNames.push(playlistName);
        }
    });

    if (exportedNames.length > 0) {
        document.getElementById("statusExport").innerText =
            `âœ… Export terminÃ© pour les playlists : ${exportedNames.join(", ")}`;
    } else {
        document.getElementById("statusExport").innerText = "âš ï¸ Aucune chanson Ã  exporter pour les playlists sÃ©lectionnÃ©es.";
    }
}

function buildCSV(songs) {
    return "Title,Artist,Album,Duration,YouTubeURL\n" +
           songs.map(s => `"${s.title}","${s.artist}","${s.album}","${s.duration}","${s.url}"`).join("\n");
}

function buildM3U(songs) {
    return "#EXTM3U\n" +
           songs.map(s => `#EXTINF:${s.duration},${s.artist} - ${s.title}\n${s.url}`).join("\n");
}

function downloadBlob(content, filename) {

    let mimeType = "text/plain";

    if (filename.endsWith(".csv")) {
        mimeType = "text/csv";
    } 
    else if (filename.endsWith(".m3u")) {
        mimeType = "audio/x-mpegurl";
    } 
    else if (filename.endsWith(".json")) {
        mimeType = "application/json";
    }

    const blob = new Blob([content], { type: mimeType });

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
}
// ---------------- IMPORT ----------------
async function handleImport(file) {
    if (!file) return;
    const status = document.getElementById("statusImport");
    status.innerText = "â³ Analyse du fichier...";
    document.getElementById("ctrlImport").classList.add("hidden");
    try {
        const text = await file.text();
        let songs = [];
        if (file.name.endsWith(".csv")) {
            const lines = text.split("\n").slice(1);
            songs = lines.filter(l=>l.trim()).map(line=>{
                const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(v=>v.replace(/^"|"$/g,''));
                return createSongObj(c[0], c[1], c[2], c[3], c[4]);
            });
        } else if (file.name.endsWith(".m3u")) {
            const lines = text.split("\n");
            for (let i=0;i<lines.length;i++){
                if(lines[i].startsWith("#EXTINF:")){
                    const info = lines[i].split(",")[1];
                    const [artist,title] = info.includes(" - ") ? info.split(" - ") : ["Inconnu", info];
                    const url = lines[i+1]?.startsWith("http") ? lines[i+1] : "";
                    songs.push(createSongObj(title.trim(), artist.trim(), "", 0, url));
                }
            }
        }
        currentData.json = JSON.stringify({ playlistInfo:{ title:file.name.split('.')[0] }, songs }, null,2);
        document.getElementById("nameImport").value = file.name.split('.')[0]+"_harmony";
        document.getElementById("ctrlImport").classList.remove("hidden");
        status.innerText = `âœ… ${songs.length} titres convertis en JSON.`;
    } catch(e) {
        console.error(e);
        status.innerText = "âŒ Erreur de lecture.";
    }
}

function createSongObj(title, artist, album, duration, url){
    const vId = url.includes("v=") ? url.split("v=")[1].split("&")[0] : "";
    return { title, artists:[{name:artist}], album:{name:album}, duration:parseInt(duration)||0, videoId:vId };
}

function downloadFile(content, ext){
    const name = (ext==='json'?document.getElementById("nameImport").value:"playlist") || "playlist";
    const blob = new Blob([content],{type:"text/plain"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=`${name}.${ext}`;
    a.click();
}
</script>
<div id="exportLinks" style="margin-top:30px; text-align:center;">
    <h3>Transfert entre sites streaming (Spotify, Deezer, YoutubeMusic ..) :</h3>
    <a href="https://www.tunemymusic.com/" target="_blank">
        <button>TuneMyMusic</button>
    </a>
    <a href="https://soundiiz.com/" target="_blank">
        <button>Soundiiz</button>
    </a>
    <a href="https://freeyourmusic.com/fr/" target="_blank">
        <button>FreeYourMusic</button>
    </a>
</div>
</body>
</html>



